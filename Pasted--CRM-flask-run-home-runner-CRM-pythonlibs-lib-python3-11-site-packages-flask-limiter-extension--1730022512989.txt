~/CRM$ flask run
/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask_limiter/extension.py:336: UserWarning: Using the in-memory storage for tracking rate limits as no storage was explicitly specified. This is not recommended for production use. See: https://flask-limiter.readthedocs.io#configuring-a-storage-backend for documentation about configuring the storage backend.
  warnings.warn(
2024-10-27 09:46:37,357 INFO: Database connection successful [in /home/runner/CRM/db_utils.py:65]
2024-10-27 09:46:39,633 INFO: Database tables already exist [in /home/runner/CRM/db_utils.py:77]
2024-10-27 09:46:39,896 DEBUG: No explicit setting existed. Use localtime [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/tzlocal/unix.py:183]
2024-10-27 09:46:39,896 INFO: Running initial email check on startup [in /home/runner/CRM/email_receiver.py:393]
2024-10-27 09:46:39,915 INFO: Adding job tentatively -- it will be properly scheduled when the scheduler starts [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/apscheduler/schedulers/base.py:454]
2024-10-27 09:46:39,916 INFO: Added job "setup_email_scheduler.<locals>.<lambda>" to job store "default" [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/apscheduler/schedulers/base.py:895]
2024-10-27 09:46:39,916 INFO: Scheduler started [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/apscheduler/schedulers/base.py:181]
2024-10-27 09:46:39,916 DEBUG: Looking for jobs to run [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/apscheduler/schedulers/base.py:954]
2024-10-27 09:46:39,916 INFO: Email scheduler started [in /home/runner/CRM/email_receiver.py:402]
 * Debug mode: off
2024-10-27 09:46:39,916 DEBUG: Next wakeup is due at 2024-10-27 09:51:39.915795+00:00 (in 299.998819 seconds) [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/apscheduler/schedulers/base.py:1034]
2024-10-27 09:46:39,918 INFO: WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on http://127.0.0.1:5000 [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:46:39,918 INFO: Press CTRL+C to quit [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:46:40,826 INFO: Attempt 1 to connect to mail server for user 2 [in /home/runner/CRM/email_receiver.py:213]
2024-10-27 09:46:40,844 INFO: Attempting to connect to imap.gmail.com for user makoto@team240.net [in /home/runner/CRM/email_receiver.py:412]
2024-10-27 09:46:41,496 DEBUG: Attempting login for makoto@team240.net [in /home/runner/CRM/email_receiver.py:421]
2024-10-27 09:46:42,134 DEBUG: Selecting inbox [in /home/runner/CRM/email_receiver.py:425]
2024-10-27 09:46:42,626 INFO: Successfully connected to mailbox for makoto@team240.net [in /home/runner/CRM/email_receiver.py:436]
2024-10-27 09:46:43,450 INFO: Skipping already processed email: <1065183910.77112.1729954979547@mail.yahoo.co.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:43,991 INFO: Skipping already processed email: <calendar-8e3b663f-8213-4b7c-8972-b08ada335ed3@google.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:44,524 INFO: Skipping already processed email: <20241026212638.D08032E8DA9@www04.vector.co.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:45,318 INFO: Skipping already processed email: <20241026224222.d107d14d86c2a055@discover.pinterest.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:46,008 INFO: Skipping already processed email: <2d6f.37a6379.m1.07810450-93ee-11ef-b8fb-525400fa05f6.192cb0ed915@mail.zohoanalytics.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:46,770 INFO: Skipping already processed email: <2d6f.3864fd7.m1.07f263c0-93ee-11ef-8705-52540064429e.192cb0edbfc@notifications.zohocalendar.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:47,542 INFO: Skipping already processed email: <2d6f.31b6c9d.m1.07c97f00-93ee-11ef-8705-52540064429e.192cb0edaee@notifications.zohoprojects.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:48,128 INFO: Skipping already processed email: <3b02e61d-e592-4458-909c-e0d866f84fbf@fc6086-aa.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:48,716 INFO: Skipping already processed email: <NM626E7142D17D71049epark_mkt_prod1@ma.epark.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:49,301 INFO: Skipping already processed email: <1832a47d-0dbd-491f-a49b-0a3b6121e0a1@fc6086-aa.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:49,911 INFO: Skipping already processed email: <01010192cb4ee339-b08ac919-aad9-4e99-a8a3-fdf9ff248a04-000000@us-west-2.amazonses.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:50,591 INFO: Skipping already processed email: <01010192cb5affdb-000335b1-689e-4440-9b61-e600203b3691-000000@us-west-2.amazonses.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:51,510 INFO: Skipping already processed email: <2d6f.38b26ff.m1.fd6f2d40-93ff-11ef-90c1-525400cbcb5e.192cb848e14@notifications.zohobooks.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:52,275 INFO: Skipping already processed email: <2d6f.38b26ff.m1.22ab0980-9400-11ef-b8fb-525400fa05f6.192cb858218@notifications.zohobooks.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:52,798 INFO: Skipping already processed email: <20241027012927.409-5b7e721d57463762989ea44a72be912d646fd8709c691c8013f7ecc6c2c12fb4@mnybk.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:53,342 INFO: Skipping already processed email: <20241027022843.866-f1f1adfebda3f3da67352d07ad7d2afa3bf180992056cc8e41e1064fd3108140@mnybk.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:53,876 INFO: Skipping already processed email: <a265f308-5e79-4670-ad39-c8040500136b@fc6086-ba.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:54,858 INFO: Skipping already processed email: <20241027031353.4693D35CB21@i30870-a3922.osmtp220.etretail.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:55,384 INFO: Skipping already processed email: <20241027033841.982-31e1c115c73da9dd6328a7c80ce804a5e9ebec0a0bede343f5df61240dd6034d@mnybk.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:56,386 INFO: Skipping already processed email: <20241027044740.0f82cd51b339f2ef@mail.zapier.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:56,940 INFO: Skipping already processed email: <2d6f.327230a.m1.c5d6ead0-9422-11ef-9691-5254000b1a0e.192cc6881fd@notifications.zohocrm.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:57,476 INFO: Skipping already processed email: <20241027063501.609-4371045be2bc6ae2a0ad296a00c54cb2729435940dce4cf391b3dd440ff2129e@mnybk.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:58,001 INFO: Skipping already processed email: <bd8f75c7-c86b-4c7b-a6bb-8a47351dcbe8@fc6086-aa.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:58,520 INFO: Skipping already processed email: <20241027081052.992AB4AA1E0@www05.vector.co.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:59,058 INFO: Skipping already processed email: <20241027084225.920bb8e7f8ee5875@discover.pinterest.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:46:59,582 INFO: Skipping already processed email: <11777773-fb8c-4380-b198-dca76a81c8af@fc6086-aa.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:00,125 INFO: Skipping already processed email: <14803968507838265679@google.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:00,712 INFO: Skipping already processed email: <2d6f.389c52e.m1.220d7c40-9448-11ef-bba4-525400f92481.192cd5d5a04@mailer.zohosalesiq.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:01,882 INFO: Processed 0 emails for user 2 [in /home/runner/CRM/email_receiver.py:348]
2024-10-27 09:47:02,921 INFO: Attempt 1 to connect to mail server for user 3 [in /home/runner/CRM/email_receiver.py:213]
2024-10-27 09:47:02,938 INFO: Attempting to connect to imap.gmail.com for user macnishio@gmail.com [in /home/runner/CRM/email_receiver.py:412]
2024-10-27 09:47:03,594 DEBUG: Attempting login for macnishio@gmail.com [in /home/runner/CRM/email_receiver.py:421]
2024-10-27 09:47:04,696 DEBUG: Selecting inbox [in /home/runner/CRM/email_receiver.py:425]
2024-10-27 09:47:05,325 INFO: Successfully connected to mailbox for macnishio@gmail.com [in /home/runner/CRM/email_receiver.py:436]
2024-10-27 09:47:05,970 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:05] "GET / HTTP/1.1" 200 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:06,160 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:06] "GET /static/css/styles.css HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:06,185 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:06] "GET /static/js/main.js HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:06,596 INFO: Detected mass email from mac_nishio@yahoo.co.jp. Reason: Sent from mass mail domain: =?utf-8?b?6kw/5bc+ioecn+ioga==?= <mac_nishio@yahoo.co.jp> | Sent during off-hours: 0:00 [in /home/runner/CRM/email_receiver.py:309]
2024-10-27 09:47:06,596 INFO: Updated lead 667 status from Contacted to Spam. Reason: Sent from mass mail domain: =?utf-8?b?6kw/5bc+ioecn+ioga==?= <mac_nishio@yahoo.co.jp> | Sent during off-hours: 0:00 [in /home/runner/CRM/email_receiver.py:167]
2024-10-27 09:47:07,313 ERROR: Error processing lead and email record: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "uq_emails_message_id"
DETAIL:  Key (message_id)=(<1065183910.77112.1729954979547@mail.yahoo.co.jp>) already exists.

[SQL: INSERT INTO emails (message_id, sender, sender_name, subject, content, received_date, lead_id, user_id) VALUES (%(message_id)s, %(sender)s, %(sender_name)s, %(subject)s, %(content)s, %(received_date)s, %(lead_id)s, %(user_id)s) RETURNING emails.id]
[parameters: {'message_id': '<1065183910.77112.1729954979547@mail.yahoo.co.jp>', 'sender': 'mac_nishio@yahoo.co.jp', 'sender_name': '西尾 真言', 'subject': 'こんにちは', 'content': "* { font-size: 13px; font-family: 'MS Pゴシック', sans-serif;}p, ul, ol, blockquote { margin: 0;}a { color: #0064c8; text-decoration: none;}a:hover { color: #0057af; text-decoration: underline;}a:active { color: #004c98;}\r\nこんにちは\r\n\r\n本日１０月２７日にの9:00にベトナム人のお客様が高座渋谷に来ます", 'received_date': datetime.datetime(2024, 10, 27, 0, 2, 59, tzinfo=datetime.timezone(datetime.timedelta(seconds=32400))), 'lead_id': 667, 'user_id': 3}]
(Background on this error at: https://sqlalche.me/e/20/gkpj) [in /home/runner/CRM/email_receiver.py:336]
2024-10-27 09:47:08,640 INFO: Skipping already processed email: <20241026151105.f9e89b440c99cad5@mg.replit.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:09,528 INFO: Skipping already processed email: <aa4624e6dbddd4dea9ac270e3049b8af@swift.generated> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:09,707 ERROR: Exception on /opportunities/ [GET] [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py:1744]
Traceback (most recent call last):
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 2529, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1825, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/routes/opportunities.py", line 13, in list_opportunities
    opportunities = Opportunity.query.filter_by(user_id=current_user.id).order_by(Opportunity.created_at.desc()).all()
                                                                                  ^^^^^^^^^^^^^^^^^^^^^^
AttributeError: type object 'Opportunity' has no attribute 'created_at'
2024-10-27 09:47:09,946 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:09] "GET /opportunities/ HTTP/1.1" 500 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:10,375 INFO: Skipping already processed email: <20241026131811.37175199.2173130@sailthru.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:10,999 INFO: Skipping already processed email: <calendar-058a1734-4217-432c-b2e4-d08174914b22@google.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:11,827 INFO: Skipping already processed email: <C_M_M_I_D.21_14_326109_0_1226.167396.1729977221@mx6.nikkei.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:12,466 INFO: Skipping already processed email: <01000192caddc2a7-d2bfabee-d380-4052-a38d-cc3331fd4707-000000@email.amazonses.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:13,084 INFO: Skipping already processed email: <OaObIuJBa_RMOB_gNFfVmA@notifications.google.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:13,730 INFO: Skipping already processed email: <86c7b7d7-3388-4372-91a4-e2fbe8249b1e@fc6086-aa.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:14,418 INFO: Skipping already processed email: <NM6327A18AD05FA863Frecruit_mkt_prod1@email.hotpepper.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:15,116 INFO: Skipping already processed email: <332091345.387359953.1729983983123@abmktmail-batch1i.marketo.org> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:15,758 INFO: Skipping already processed email: <d13f1d6e-c8d4-454e-a592-3bd2aa7009ad@fc6086-aa.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:16,377 INFO: Skipping already processed email: <4XbbKH4jbXzhqp29@mailout.ml3.sbcr.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:16,712 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:16] "GET / HTTP/1.1" 200 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:16,902 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:16] "GET /static/css/styles.css HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:16,920 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:16] "GET /static/js/main.js HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:17,004 INFO: Skipping already processed email: <calendar-c2a23850-d4b7-4238-bc84-3483853e58a3@google.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:17,634 INFO: Skipping already processed email: <34a266858c858ba62b9b80e455a14e89@swift.generated> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:18,274 INFO: Skipping already processed email: <01010192cb52fdbd-52c8a361-775e-49db-965a-5017e91f675c-000000@us-west-2.amazonses.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:19,122 INFO: Skipping already processed email: <66942a26-9aba-4623-846c-adf5f6513eb0@mag-sdsrv21-fc04.tsite.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:19,784 INFO: Skipping already processed email: <159bd998-0cc6-4a72-9cff-9d01c361904d@atl1s11mta372.xt.local> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:20,646 INFO: Skipping already processed email: <01060192cb7deb34-935f7efa-d452-4c2a-b45a-007aba8b555d-000000@ap-northeast-1.amazonses.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:21,297 INFO: Skipping already processed email: <RTNs01BXToGCP0gV-S78ZQ@geopod-ismtpd-20> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:21,421 ERROR: Exception on /tasks/ [GET] [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py:1744]
Traceback (most recent call last):
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 2529, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1825, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/routes/tasks.py", line 14, in list_tasks
    return render_template('tasks/list_tasks.html', tasks=tasks)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/templating.py", line 147, in render_template
    return _render(app, template, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/templating.py", line 130, in _render
    rv = template.render(context)
         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/jinja2/environment.py", line 1304, in render
    self.environment.handle_exception()
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/jinja2/environment.py", line 939, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "/home/runner/CRM/templates/tasks/list_tasks.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "/home/runner/CRM/templates/base.html", line 49, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/templates/tasks/list_tasks.html", line 34, in block 'content'
    <form method="POST" action="{{ url_for('tasks.bulk_action') }}" id="bulkForm">
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 2034, in url_for
    return self.handle_url_build_error(error, endpoint, values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/routing/map.py", line 917, in build
    raise BuildError(endpoint, values, method, self)
werkzeug.routing.exceptions.BuildError: Could not build url for endpoint 'tasks.bulk_action'. Did you mean 'schedules.bulk_action' instead?
2024-10-27 09:47:21,664 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:21] "GET /tasks/ HTTP/1.1" 500 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:21,990 INFO: Skipping already processed email: <01060192cb8071c8-aa122e5a-a8b1-4ab3-a803-366a679d55e7-000000@ap-northeast-1.amazonses.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:22,859 INFO: Skipping already processed email: <20211203000000.135914068.1000.104099@mkrm.rakuten.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:23,493 INFO: Skipping already processed email: <0YQNkg1vSS2bRIzloKXq7A@geopod-ismtpd-7> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:24,149 INFO: Skipping already processed email: <1729991842283.2024101491.shopjpn.0.121288.01000000@ad438se.mpse.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:24,798 INFO: Skipping already processed email: <1729991927084.2024109407.bd200.0.11714.00000000@ad386se.mpse.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:25,420 INFO: Skipping already processed email: <4Xbdzn51DYzhvnWC@mailout.ml3.sbcr.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:26,067 INFO: Skipping already processed email: <01010192cb9e1be5-5f7825b5-03cf-496a-a706-fffd64000e72-000000@us-west-2.amazonses.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:26,694 INFO: Skipping already processed email: <1729992056.12284149140@aiasahi.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:27,325 INFO: Skipping already processed email: <3a7780c1-96b4-464b-8fac-cda8561ba3e2@fc5866.toyokeizai.net> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:27,938 INFO: Skipping already processed email: <e3fed7c6-b968-47c6-8598-c9bbc50a0ec0@fc4167.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:28,552 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:28] "GET / HTTP/1.1" 200 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:28,560 INFO: Skipping already processed email: <000kpw-0k382@b236.repica.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:28,752 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:28] "GET /static/css/styles.css HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:28,759 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:28] "GET /static/js/main.js HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:29,198 INFO: Skipping already processed email: <1729995115395.2024101016.gnavi.0.813349.00000000@ad164se.mpse.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:30,057 INFO: Skipping already processed email: <01060192cbc40dc0-076f3976-1c3b-4937-a092-a7f7edd88c6b-000000@ap-northeast-1.amazonses.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:30,700 INFO: Skipping already processed email: <20211203000000.135913359.1000.24300@mkrm.rakuten.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:31,343 INFO: Skipping already processed email: <1729995779092.2024112294.bd174.0.182090.00000000@ad386se.mpse.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:31,998 INFO: Skipping already processed email: <458.8032153533.202410270226238353003.0018167201@news.wowma.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:32,060 DEBUG: load_ssl_context verify=True cert=None trust_env=True http2=False [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpx/_config.py:82]
2024-10-27 09:47:32,060 DEBUG: load_verify_locations cafile='/etc/ssl/certs/ca-certificates.crt' [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpx/_config.py:148]
2024-10-27 09:47:32,078 DEBUG: Request options: {'method': 'post', 'url': '/v1/messages', 'timeout': 600, 'files': None, 'json_data': {'max_tokens': 4000, 'messages': [{'role': 'user', 'content': '今は日本時間の2024-10-27です。以下のスケジュールデータを分析してください:\n- タイトル: 高座渋谷での会議, 開始: 2024-10-26 15:07:32.894382, 終了: 2024-10-26 16:07:32.894382\n\n        以下の項目について簡潔に分析してください:\n        1. スケジュールの密度と時間配分\n        2. 重要な予定の特定\n        3. スケジュール管理の効率化\n        4. バランス改善のための提案\n        回答は日本語でお願いします。HTMLの段落タグ（<p>）を使用してフォーマットしてください。'}], 'model': 'claude-3-haiku-20240307'}} [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:446]
2024-10-27 09:47:32,082 DEBUG: Sending HTTP Request: POST https://api.anthropic.com/v1/messages [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:970]
2024-10-27 09:47:32,082 DEBUG: connect_tcp.started host='api.anthropic.com' port=443 local_address=None timeout=600 socket_options=None [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:32,094 DEBUG: connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7efcfff68450> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:32,094 DEBUG: start_tls.started ssl_context=<ssl.SSLContext object at 0x7efd0038c440> server_hostname='api.anthropic.com' timeout=600 [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:32,107 DEBUG: start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7efcfff4e350> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:32,107 DEBUG: send_request_headers.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:32,108 DEBUG: send_request_headers.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:32,108 DEBUG: send_request_body.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:32,108 DEBUG: send_request_body.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:32,108 DEBUG: receive_response_headers.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:32,625 INFO: Skipping already processed email: <hm2m14212g12c124419334@b33.hm-f.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:33,304 INFO: Skipping already processed email: <zcb.3z53ddacba440616cfccfab681941f1a3742cf0d1263a0a0c920b472eafae7e292.1ad5af6f55e6bdc4.1729996307005@zcmp.funaisoken.co.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:33,967 INFO: Skipping already processed email: <sc6v5.rce8znzQ/38=.stepon-news@stepon.co.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:34,609 INFO: Skipping already processed email: <sc6v5.Rxmvg1bZlCY=.stepon-news@stepon.co.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:35,246 INFO: Skipping already processed email: <1668393975.4425419.1729997801134@deliver-74b96dd6bb-2r4sx> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:36,011 DEBUG: receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sun, 27 Oct 2024 09:47:36 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'anthropic-ratelimit-requests-limit', b'2000'), (b'anthropic-ratelimit-requests-remaining', b'1999'), (b'anthropic-ratelimit-requests-reset', b'2024-10-27T09:48:20Z'), (b'anthropic-ratelimit-tokens-limit', b'200000'), (b'anthropic-ratelimit-tokens-remaining', b'200000'), (b'anthropic-ratelimit-tokens-reset', b'2024-10-27T09:47:35Z'), (b'request-id', b'req_014UVDVpe5AN7hcGyo5kZ4Tr'), (b'via', b'1.1 google'), (b'CF-Cache-Status', b'DYNAMIC'), (b'X-Robots-Tag', b'none'), (b'Server', b'cloudflare'), (b'CF-RAY', b'8d91c3e5b9aa3a1f-BOM'), (b'Content-Encoding', b'gzip')]) [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:36,011 INFO: HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK" [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpx/_client.py:1038]
2024-10-27 09:47:36,011 DEBUG: receive_response_body.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:36,012 DEBUG: receive_response_body.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:36,012 DEBUG: response_closed.started [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:36,012 DEBUG: response_closed.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:36,012 DEBUG: HTTP Response: POST https://api.anthropic.com/v1/messages "200 OK" Headers({'date': 'Sun, 27 Oct 2024 09:47:36 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'anthropic-ratelimit-requests-limit': '2000', 'anthropic-ratelimit-requests-remaining': '1999', 'anthropic-ratelimit-requests-reset': '2024-10-27T09:48:20Z', 'anthropic-ratelimit-tokens-limit': '200000', 'anthropic-ratelimit-tokens-remaining': '200000', 'anthropic-ratelimit-tokens-reset': '2024-10-27T09:47:35Z', 'request-id': 'req_014UVDVpe5AN7hcGyo5kZ4Tr', 'via': '1.1 google', 'cf-cache-status': 'DYNAMIC', 'x-robots-tag': 'none', 'server': 'cloudflare', 'cf-ray': '8d91c3e5b9aa3a1f-BOM', 'content-encoding': 'gzip'}) [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:1009]
2024-10-27 09:47:36,012 DEBUG: request_id: req_014UVDVpe5AN7hcGyo5kZ4Tr [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:1017]
2024-10-27 09:47:36,132 INFO: Skipping already processed email: <671dae4aedabc_7103b030395@ip-10-65-2-50.ap-northeast-1.compute.internal.mail> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:36,260 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:36] "GET /schedules HTTP/1.1" 200 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:36,445 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:36] "GET /static/css/styles.css HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:36,455 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:36] "GET /static/js/main.js HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:36,811 INFO: Skipping already processed email: <1712292750.4454804.1730002086135@deliver-74b96dd6bb-s77q5> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:37,477 INFO: Skipping already processed email: <40248ff0-a779-4f96-bcae-8b11be8137bd@iad4s12mta478.xt.local> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:38,131 INFO: Skipping already processed email: <06.43.04196.8E5BD176@clients.taguchimail.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:38,756 INFO: Skipping already processed email: <671dc2fe.050a0220.2fe848.f16aSMTPIN_ADDED_MISSING@mx.google.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:39,394 INFO: Skipping already processed email: <1ea477a8-516e-4958-8642-8c7f9664743d@sqmerr.gnavi.co.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:40,009 INFO: Skipping already processed email: <4XbktK71p6zhgB4k@mailout.ml3.sbcr.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:40,646 INFO: Skipping already processed email: <4XblJD6R9Czhp0Jl@mailout.ml3.sbcr.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:41,152 ERROR: Exception on /schedules/add [GET] [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py:1744]
Traceback (most recent call last):
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 2529, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1825, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/routes/schedules.py", line 123, in add_schedule
    return render_template('schedules/add_schedule.html', leads=leads)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/templating.py", line 147, in render_template
    return _render(app, template, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/templating.py", line 130, in _render
    rv = template.render(context)
         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/jinja2/environment.py", line 1304, in render
    self.environment.handle_exception()
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/jinja2/environment.py", line 939, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "/home/runner/CRM/templates/schedules/add_schedule.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "/home/runner/CRM/templates/base.html", line 49, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/templates/schedules/add_schedule.html", line 16, in block 'content'
    {{ form.hidden_tag() }}
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/jinja2/environment.py", line 487, in getattr
    return getattr(obj, attribute)
           ^^^^^^^^^^^^^^^^^^^^^^^
jinja2.exceptions.UndefinedError: 'form' is undefined
2024-10-27 09:47:41,260 INFO: Skipping already processed email: <hm2m14216g12c124419334@b33.hm-f.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:41,391 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:41] "GET /schedules/add HTTP/1.1" 500 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:41,875 INFO: Skipping already processed email: <CL2rHUqrZprK3NNkJQQ9pw@notifications.google.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:42,490 INFO: Skipping already processed email: <49b22700-8cb6-4bf7-93e2-fedbd4c4ed9e@fc6086-aa.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:43,124 INFO: Skipping already processed email: <1730009623733.2024101504.shopjpn.0.173270.01000000@ad438se.mpse.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:43,973 INFO: Skipping already processed email: <1730009767168.2024164073.bd006.0.11739.00000000@ad390se.mpse.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:44,599 INFO: Skipping already processed email: <1730011564311.2024100590.cap9.0.3092861.01100000@ad300recse.rec.mpse.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:45,214 INFO: Skipping already processed email: <4XbnXc61Xkzhd2kP@mailout.ml3.sbcr.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:45,616 DEBUG: load_ssl_context verify=True cert=None trust_env=True http2=False [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpx/_config.py:82]
2024-10-27 09:47:45,616 DEBUG: load_verify_locations cafile='/etc/ssl/certs/ca-certificates.crt' [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpx/_config.py:148]
2024-10-27 09:47:45,634 DEBUG: Request options: {'method': 'post', 'url': '/v1/messages', 'timeout': 600, 'files': None, 'json_data': {'max_tokens': 4000, 'messages': [{'role': 'user', 'content': '今は日本時間の2024-10-27です。以下のスケジュールデータを分析してください:\n- タイトル: 高座渋谷での会議, 開始: 2024-10-26 15:07:32.894382, 終了: 2024-10-26 16:07:32.894382\n\n        以下の項目について簡潔に分析してください:\n        1. スケジュールの密度と時間配分\n        2. 重要な予定の特定\n        3. スケジュール管理の効率化\n        4. バランス改善のための提案\n        回答は日本語でお願いします。HTMLの段落タグ（<p>）を使用してフォーマットしてください。'}], 'model': 'claude-3-haiku-20240307'}} [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:446]
2024-10-27 09:47:45,635 DEBUG: Sending HTTP Request: POST https://api.anthropic.com/v1/messages [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:970]
2024-10-27 09:47:45,635 DEBUG: connect_tcp.started host='api.anthropic.com' port=443 local_address=None timeout=600 socket_options=None [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:45,640 DEBUG: connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7efcffff04d0> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:45,640 DEBUG: start_tls.started ssl_context=<ssl.SSLContext object at 0x7efcfff9eba0> server_hostname='api.anthropic.com' timeout=600 [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:45,650 DEBUG: start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7efcfff50210> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:45,650 DEBUG: send_request_headers.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:45,650 DEBUG: send_request_headers.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:45,650 DEBUG: send_request_body.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:45,651 DEBUG: send_request_body.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:45,651 DEBUG: receive_response_headers.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:45,850 INFO: Skipping already processed email: <fe790877-2a87-464b-8dac-c1c65b4649de@fc5866.toyokeizai.net> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:46,486 INFO: Skipping already processed email: <000kq7-0k371@b236.repica.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:47,117 INFO: Skipping already processed email: <34e61b60-3ceb-4b61-af3e-64a5bd5798a3@fc6086-aa.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:47,822 INFO: Skipping already processed email: <c3b1b1dc-2cf4-42e1-8299-b1e3e97a4d18@dfw1s10mta1162.xt.local> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:48,468 INFO: Skipping already processed email: <671dfbd89ec44_8103b012474@ip-10-65-2-7.ap-northeast-1.compute.internal.mail> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:49,106 INFO: Skipping already processed email: <671e0218.630a0220.2bdb2.67c9SMTPIN_ADDED_MISSING@mx.google.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:49,372 DEBUG: receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sun, 27 Oct 2024 09:47:49 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'anthropic-ratelimit-requests-limit', b'2000'), (b'anthropic-ratelimit-requests-remaining', b'1999'), (b'anthropic-ratelimit-requests-reset', b'2024-10-27T09:48:20Z'), (b'anthropic-ratelimit-tokens-limit', b'200000'), (b'anthropic-ratelimit-tokens-remaining', b'200000'), (b'anthropic-ratelimit-tokens-reset', b'2024-10-27T09:47:49Z'), (b'request-id', b'req_01SmWNjMho7BCMbadKCFZ2vf'), (b'via', b'1.1 google'), (b'CF-Cache-Status', b'DYNAMIC'), (b'X-Robots-Tag', b'none'), (b'Server', b'cloudflare'), (b'CF-RAY', b'8d91c43a5d8247e8-BOM'), (b'Content-Encoding', b'gzip')]) [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:49,372 INFO: HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK" [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpx/_client.py:1038]
2024-10-27 09:47:49,372 DEBUG: receive_response_body.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:49,373 DEBUG: receive_response_body.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:49,373 DEBUG: response_closed.started [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:49,373 DEBUG: response_closed.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:49,373 DEBUG: HTTP Response: POST https://api.anthropic.com/v1/messages "200 OK" Headers({'date': 'Sun, 27 Oct 2024 09:47:49 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'anthropic-ratelimit-requests-limit': '2000', 'anthropic-ratelimit-requests-remaining': '1999', 'anthropic-ratelimit-requests-reset': '2024-10-27T09:48:20Z', 'anthropic-ratelimit-tokens-limit': '200000', 'anthropic-ratelimit-tokens-remaining': '200000', 'anthropic-ratelimit-tokens-reset': '2024-10-27T09:47:49Z', 'request-id': 'req_01SmWNjMho7BCMbadKCFZ2vf', 'via': '1.1 google', 'cf-cache-status': 'DYNAMIC', 'x-robots-tag': 'none', 'server': 'cloudflare', 'cf-ray': '8d91c43a5d8247e8-BOM', 'content-encoding': 'gzip'}) [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:1009]
2024-10-27 09:47:49,373 DEBUG: request_id: req_01SmWNjMho7BCMbadKCFZ2vf [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:1017]
2024-10-27 09:47:49,612 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:49] "GET /schedules HTTP/1.1" 200 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:49,722 INFO: Skipping already processed email: <bfcdff6c-70e9-437b-b88b-889a3d3203b5@fc4167.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:49,821 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:49] "GET /static/css/styles.css HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:49,831 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:49] "GET /static/js/main.js HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:50,348 INFO: Skipping already processed email: <094e7e87-c2b8-4693-a3c7-88c0fbeb8209@fc6086-ba.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:51,035 INFO: Skipping already processed email: <916925261.388361945.1730020074729@abmktmail-batch1f.marketo.org> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:51,723 INFO: Skipping already processed email: <C_M_M_I_D.21_14_326160_0_1228.167391.1730020569@mx6.nikkei.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:52,880 DEBUG: close.started [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:52,881 DEBUG: close.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:53,085 INFO: Processed 0 emails for user 3 [in /home/runner/CRM/email_receiver.py:348]
2024-10-27 09:47:53,129 ERROR: Exception on /leads/ [GET] [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py:1744]
Traceback (most recent call last):
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 2529, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1825, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/routes/leads.py", line 14, in list_leads
    return render_template('leads/list_leads.html', leads=leads)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/templating.py", line 147, in render_template
    return _render(app, template, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/templating.py", line 130, in _render
    rv = template.render(context)
         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/jinja2/environment.py", line 1304, in render
    self.environment.handle_exception()
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/jinja2/environment.py", line 939, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "/home/runner/CRM/templates/leads/list_leads.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "/home/runner/CRM/templates/base.html", line 49, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/templates/leads/list_leads.html", line 29, in block 'content'
    <a href="{{ url_for('leads.update_empty_names') }}" class="btn btn-info">空の名前を更新</a>
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 2034, in url_for
    return self.handle_url_build_error(error, endpoint, values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/routing/map.py", line 917, in build
    raise BuildError(endpoint, values, method, self)
werkzeug.routing.exceptions.BuildError: Could not build url for endpoint 'leads.update_empty_names'. Did you mean 'leads.delete_lead' instead?
2024-10-27 09:47:53,369 INFO: 127.0.0.1 - - [27/Oct/2024 09:47:53] "GET /leads/ HTTP/1.1" 500 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:47:54,289 INFO: Attempt 1 to connect to mail server for user 4 [in /home/runner/CRM/email_receiver.py:213]
2024-10-27 09:47:54,306 INFO: Attempting to connect to imap.gmail.com for user darkare0323@gmail.com [in /home/runner/CRM/email_receiver.py:412]
2024-10-27 09:47:54,970 DEBUG: Attempting login for darkare0323@gmail.com [in /home/runner/CRM/email_receiver.py:421]
2024-10-27 09:47:55,364 DEBUG: Selecting inbox [in /home/runner/CRM/email_receiver.py:425]
2024-10-27 09:47:55,756 INFO: Successfully connected to mailbox for darkare0323@gmail.com [in /home/runner/CRM/email_receiver.py:436]
2024-10-27 09:47:56,841 INFO: Detected mass email from mac_nishio@yahoo.co.jp. Reason: Sent from mass mail domain: =?utf-8?b?6kw/5bc+ioecn+ioga==?= <mac_nishio@yahoo.co.jp> | Sent during off-hours: 0:00 [in /home/runner/CRM/email_receiver.py:309]
2024-10-27 09:47:56,841 INFO: Updated lead 670 status from Contacted to Spam. Reason: Sent from mass mail domain: =?utf-8?b?6kw/5bc+ioecn+ioga==?= <mac_nishio@yahoo.co.jp> | Sent during off-hours: 0:00 [in /home/runner/CRM/email_receiver.py:167]
2024-10-27 09:47:57,522 ERROR: Error processing lead and email record: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "uq_emails_message_id"
DETAIL:  Key (message_id)=(<1065183910.77112.1729954979547@mail.yahoo.co.jp>) already exists.

[SQL: INSERT INTO emails (message_id, sender, sender_name, subject, content, received_date, lead_id, user_id) VALUES (%(message_id)s, %(sender)s, %(sender_name)s, %(subject)s, %(content)s, %(received_date)s, %(lead_id)s, %(user_id)s) RETURNING emails.id]
[parameters: {'message_id': '<1065183910.77112.1729954979547@mail.yahoo.co.jp>', 'sender': 'mac_nishio@yahoo.co.jp', 'sender_name': '西尾 真言', 'subject': 'こんにちは', 'content': "* { font-size: 13px; font-family: 'MS Pゴシック', sans-serif;}p, ul, ol, blockquote { margin: 0;}a { color: #0064c8; text-decoration: none;}a:hover { color: #0057af; text-decoration: underline;}a:active { color: #004c98;}\r\nこんにちは\r\n\r\n本日１０月２７日にの9:00にベトナム人のお客様が高座渋谷に来ます", 'received_date': datetime.datetime(2024, 10, 27, 0, 2, 59, tzinfo=datetime.timezone(datetime.timedelta(seconds=32400))), 'lead_id': 670, 'user_id': 4}]
(Background on this error at: https://sqlalche.me/e/20/gkpj) [in /home/runner/CRM/email_receiver.py:336]
2024-10-27 09:47:57,545 DEBUG: close.started [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:57,545 DEBUG: close.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:58,024 DEBUG: load_ssl_context verify=True cert=None trust_env=True http2=False [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpx/_config.py:82]
2024-10-27 09:47:58,025 DEBUG: load_verify_locations cafile='/etc/ssl/certs/ca-certificates.crt' [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpx/_config.py:148]
2024-10-27 09:47:58,042 DEBUG: Request options: {'method': 'post', 'url': '/v1/messages', 'timeout': 600, 'files': None, 'json_data': {'max_tokens': 4000, 'messages': [{'role': 'user', 'content': '今は日本時間の2024-10-27です。以下のスケジュールデータを分析してください:\n- タイトル: 高座渋谷での会議, 開始: 2024-10-26 15:07:32.894382, 終了: 2024-10-26 16:07:32.894382\n\n        以下の項目について簡潔に分析してください:\n        1. スケジュールの密度と時間配分\n        2. 重要な予定の特定\n        3. スケジュール管理の効率化\n        4. バランス改善のための提案\n        回答は日本語でお願いします。HTMLの段落タグ（<p>）を使用してフォーマットしてください。'}], 'model': 'claude-3-haiku-20240307'}} [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:446]
2024-10-27 09:47:58,042 DEBUG: Sending HTTP Request: POST https://api.anthropic.com/v1/messages [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:970]
2024-10-27 09:47:58,042 DEBUG: connect_tcp.started host='api.anthropic.com' port=443 local_address=None timeout=600 socket_options=None [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:58,046 DEBUG: connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7efcffffb110> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:58,046 DEBUG: start_tls.started ssl_context=<ssl.SSLContext object at 0x7efcfff9eba0> server_hostname='api.anthropic.com' timeout=600 [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:58,053 DEBUG: start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7efcffffa690> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:58,053 DEBUG: send_request_headers.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:58,053 DEBUG: send_request_headers.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:58,053 DEBUG: send_request_body.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:58,054 DEBUG: send_request_body.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:58,054 DEBUG: receive_response_headers.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:47:59,059 INFO: Skipping already processed email: <0ba0ac0c-2e9e-4db0-b87d-be77e0f3526c@fra3s50mta466.xt.local> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:47:59,586 INFO: Skipping already processed email: <2d6f.327230a.m1.1e4b58e0-9400-11ef-9a6d-525400ae9113.192cb85656e@sender5.zohocrm.com> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:48:00,125 INFO: Skipping already processed email: <kreisel.d.cookpad.182579.173024@krs.bz> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:48:00,767 INFO: Skipping already processed email: <1745595790.181658775.1729991886095.JavaMail.tomcat@vera-0> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:48:01,533 INFO: Skipping already processed email: <cb0ae955-4ef5-4ebd-a1a4-1d2c4b4f73a0@mag-sdsrv22-fc04.tsite.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:48:01,698 DEBUG: receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sun, 27 Oct 2024 09:48:01 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'anthropic-ratelimit-requests-limit', b'2000'), (b'anthropic-ratelimit-requests-remaining', b'1999'), (b'anthropic-ratelimit-requests-reset', b'2024-10-27T09:48:20Z'), (b'anthropic-ratelimit-tokens-limit', b'200000'), (b'anthropic-ratelimit-tokens-remaining', b'200000'), (b'anthropic-ratelimit-tokens-reset', b'2024-10-27T09:48:01Z'), (b'request-id', b'req_01GZ4gaS843wDkEzMqpYkNDT'), (b'via', b'1.1 google'), (b'CF-Cache-Status', b'DYNAMIC'), (b'X-Robots-Tag', b'none'), (b'Server', b'cloudflare'), (b'CF-RAY', b'8d91c487ddc83a2a-BOM'), (b'Content-Encoding', b'gzip')]) [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:48:01,699 INFO: HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK" [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpx/_client.py:1038]
2024-10-27 09:48:01,699 DEBUG: receive_response_body.started request=<Request [b'POST']> [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:48:01,699 DEBUG: receive_response_body.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:48:01,699 DEBUG: response_closed.started [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:48:01,699 DEBUG: response_closed.complete [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/httpcore/_trace.py:45]
2024-10-27 09:48:01,699 DEBUG: HTTP Response: POST https://api.anthropic.com/v1/messages "200 OK" Headers({'date': 'Sun, 27 Oct 2024 09:48:01 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'anthropic-ratelimit-requests-limit': '2000', 'anthropic-ratelimit-requests-remaining': '1999', 'anthropic-ratelimit-requests-reset': '2024-10-27T09:48:20Z', 'anthropic-ratelimit-tokens-limit': '200000', 'anthropic-ratelimit-tokens-remaining': '200000', 'anthropic-ratelimit-tokens-reset': '2024-10-27T09:48:01Z', 'request-id': 'req_01GZ4gaS843wDkEzMqpYkNDT', 'via': '1.1 google', 'cf-cache-status': 'DYNAMIC', 'x-robots-tag': 'none', 'server': 'cloudflare', 'cf-ray': '8d91c487ddc83a2a-BOM', 'content-encoding': 'gzip'}) [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:1009]
2024-10-27 09:48:01,699 DEBUG: request_id: req_01GZ4gaS843wDkEzMqpYkNDT [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/anthropic/_base_client.py:1017]
2024-10-27 09:48:01,938 INFO: 127.0.0.1 - - [27/Oct/2024 09:48:01] "GET /schedules HTTP/1.1" 200 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:48:02,093 INFO: Skipping already processed email: <02j7rh-000xz@b184.repica.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:48:02,136 INFO: 127.0.0.1 - - [27/Oct/2024 09:48:02] "GET /static/css/styles.css HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:48:02,148 INFO: 127.0.0.1 - - [27/Oct/2024 09:48:02] "GET /static/js/main.js HTTP/1.1" 304 - [in /home/runner/CRM/.pythonlibs/lib/python3.11/site-packages/werkzeug/_internal.py:224]
2024-10-27 09:48:02,633 INFO: Skipping already processed email: <02j7rh-000xv@b184.repica.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:48:03,149 INFO: Skipping already processed email: <b7edc15e-ede9-4405-bc89-b156cd8cdbd7@fc8713.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:48:03,675 INFO: Skipping already processed email: <f657f36b-b2e3-4fb6-bf9b-1cf78d12a15e@fc8713.cuenote.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:48:04,261 INFO: Skipping already processed email: <450f2a43-d666-4f9e-a862-8e72999ff4c0@fc01a.tsite.jp> [in /home/runner/CRM/email_receiver.py:275]
2024-10-27 09:48:05,656 INFO: Processed 0 emails for user 4 [in /home/runner/CRM/email_receiver.py:348]
2024-10-27 09:48:06,693 INFO: Attempt 1 to connect to mail server for user 6 [in /home/runner/CRM/email_receiver.py:213]
2024-10-27 09:48:06,711 INFO: Attempting to connect to imap.gmail.com for user linminghui@team240.net [in /home/runner/CRM/email_receiver.py:412]
2024-10-27 09:48:07,425 DEBUG: Attempting login for linminghui@team240.net [in /home/runner/CRM/email_receiver.py:421]
2024-10-27 09:48:08,069 DEBUG: Selecting inbox [in /home/runner/CRM/email_receiver.py:425]
2024-10-27 09:48:08,390 INFO: Successfully connected to mailbox for linminghui@team240.net [in /home/runner/CRM/email_receiver.py:436]
2024-10-27 09:48:09,509 INFO: Detected mass email from mac_nishio@yahoo.co.jp. Reason: Sent from mass mail domain: =?utf-8?b?6kw/5bc+ioecn+ioga==?= <mac_nishio@yahoo.co.jp> | Sent during off-hours: 0:00 [in /home/runner/CRM/email_receiver.py:309]
2024-10-27 09:48:09,509 INFO: Updated lead 671 status from Contacted to Spam. Reason: Sent from mass mail domain: =?utf-8?b?6kw/5bc+ioecn+ioga==?= <mac_nishio@yahoo.co.jp> | Sent during off-hours: 0:00 [in /home/runner/CRM/email_receiver.py:167]
2024-10-27 09:48:10,224 ERROR: Error processing lead and email record: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "uq_emails_message_id"
DETAIL:  Key (message_id)=(<1065183910.77112.1729954979547@mail.yahoo.co.jp>) already exists.

[SQL: INSERT INTO emails (message_id, sender, sender_name, subject, content, received_date, lead_id, user_id) VALUES (%(message_id)s, %(sender)s, %(sender_name)s, %(subject)s, %(content)s, %(received_date)s, %(lead_id)s, %(user_id)s) RETURNING emails.id]
[parameters: {'message_id': '<1065183910.77112.1729954979547@mail.yahoo.co.jp>', 'sender': 'mac_nishio@yahoo.co.jp', 'sender_name': '西尾 真言', 'subject': 'こんにちは', 'content': "* { font-size: 13px; font-family: 'MS Pゴシック', sans-serif;}p, ul, ol, blockquote { margin: 0;}a { color: #0064c8; text-decoration: none;}a:hover { color: #0057af; text-decoration: underline;}a:active { color: #004c98;}\r\nこんにちは\r\n\r\n本日１０月２７日にの9:00にベトナム人のお客様が高座渋谷に来ます", 'received_date': datetime.datetime(2024, 10, 27, 0, 2, 59, tzinfo=datetime.timezone(datetime.timedelta(seconds=32400))), 'lead_id': 671, 'user_id': 6}]
(Background on this error at: https://sqlalche.me/e/20/gkpj) [in /home/runner/CRM/email_receiver.py:336]
2024-10-27 09:48:12,071 INFO: Processed 0 emails for user 6 [in /home/runner/CRM/email_receiver.py:348]
2024-10-27 09:48:12,681 INFO: Processed emails for 4 users [in /home/runner/CRM/email_receiver.py:383]
