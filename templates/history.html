{% extends "base.html" %}

{% block title %}{{ lead.name }}とのコミュニケーション履歴{% endblock %}

{% block styles %}
<style>
.history-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: #f5f5f5;
    height: calc(100vh - 100px);
    display: flex;
    flex-direction: column;
}

.messages-container {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column-reverse;
}

.message {
    max-width: 70%;
    margin: 10px;
    padding: 10px;
    border-radius: 10px;
    position: relative;
}

.message.from-lead {
    background: #8de055;
    margin-left: auto;
}

.message.from-system {
    background: white;
    margin-right: auto;
}

.message-time {
    font-size: 0.8em;
    color: #666;
    margin-top: 5px;
}

.message-content {
    word-break: break-word;
}

.load-more {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    cursor: pointer;
    margin: 10px 0;
}

.load-more:hover {
    background: #e9ecef;
}

.lead-info {
    padding: 10px;
    background: white;
    border-bottom: 1px solid #ddd;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="history-container">
    <div class="lead-info">
        <h2>{{ lead.name }}とのコミュニケーション履歴</h2>
        {% if lead.email %}
        <p>メール: {{ lead.email }}</p>
        {% endif %}
    </div>
    
    <div class="messages-container" id="messages">
        <!-- メッセージはJavaScriptで動的に追加されます -->
    </div>
    
    <div class="load-more" id="loadMore" style="display: none;">
        さらに読み込む
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let hasMore = false;
const leadId = {{ lead.id }};

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function createMessageElement(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.is_from_lead ? 'from-lead' : 'from-system'}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.textContent = message.content;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = formatDate(message.received_date);
    
    messageDiv.appendChild(contentDiv);
    messageDiv.appendChild(timeDiv);
    
    return messageDiv;
}

async function loadMessages(page = 1) {
    try {
        const response = await fetch(`/api/history/${leadId}?page=${page}`);
        const data = await response.json();
        
        const messagesContainer = document.getElementById('messages');
        data.messages.forEach(message => {
            messagesContainer.appendChild(createMessageElement(message));
        });
        
        hasMore = data.has_next;
        document.getElementById('loadMore').style.display = hasMore ? 'block' : 'none';
        
    } catch (error) {
        console.error('メッセージの読み込み中にエラーが発生しました:', error);
    }
}

document.getElementById('loadMore').addEventListener('click', () => {
    if (hasMore) {
        currentPage++;
        loadMessages(currentPage);
    }
});

// 初期読み込み
loadMessages();
</script>
{% endblock %}
