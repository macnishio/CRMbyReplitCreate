{% extends "base.html" %}
{% block title %}ダッシュボード{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>今月の売上</h3>
            <p class="metric-value">¥{{ "{:,.0f}".format(this_month_revenue or 0) }}</p>
            {% if previous_month_revenue and previous_month_revenue > 0 %}
                {% set revenue_change = ((this_month_revenue or 0) - (previous_month_revenue or 0)) / (previous_month_revenue or 1) * 100 %}
                <p class="metric-change {% if revenue_change >= 0 %}positive{% else %}negative{% endif %}">
                    {{ "{:+.1f}".format(revenue_change) }}% 先月比
                </p>
            {% else %}
                <p class="metric-change">前月データなし</p>
            {% endif %}
        </div>
        <div class="metric-card">
            <h3>先月の売上</h3>
            <p class="metric-value">¥{{ "{:,.0f}".format(previous_month_revenue or 0) }}</p>
        </div>
        <div class="metric-card">
            <h3>商談パイプライン</h3>
            <p class="metric-value">¥{{ "{:,.0f}".format(total_pipeline or 0) }}</p>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="dashboard-section">
            <h2>最近のリード</h2>
            <div class="dashboard-list">
                {% if leads and leads.items %}
                    {% for lead in leads.items %}
                    <a href="{{ url_for('leads.edit_lead', id=lead.id) }}" class="card-link">
                        <div class="dashboard-item">
                            <h3>{{ lead.name or '名前なし' }}</h3>
                            <p>{{ lead.email }}</p>
                            <p>スコア: {{ "%.1f"|format(lead.score or 0) }}</p>
                            <p>ステータス: {{ lead.status }}</p>
                        </div>
                    </a>
                    {% endfor %}
                    {% if leads.pages > 1 %}
                    <div class="pagination">
                        {% if leads.has_prev %}
                            <a href="{{ url_for('main.dashboard', leads_page=leads.prev_num, tasks_page=request.args.get('tasks_page', 1), schedules_page=request.args.get('schedules_page', 1), emails_page=request.args.get('emails_page', 1)) }}" class="page-link">&laquo; 前へ</a>
                        {% endif %}
                        <span class="page-info">{{ leads.page }} / {{ leads.pages }}</span>
                        {% if leads.has_next %}
                            <a href="{{ url_for('main.dashboard', leads_page=leads.next_num, tasks_page=request.args.get('tasks_page', 1), schedules_page=request.args.get('schedules_page', 1), emails_page=request.args.get('emails_page', 1)) }}" class="page-link">次へ &raquo;</a>
                        {% endif %}
                    </div>
                    {% endif %}
                {% else %}
                    <p>リードはありません</p>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-section">
            <h2>商談ステージ別集計</h2>
            <div class="dashboard-list">
                {% for stage, count, amount in opportunities %}
                <a href="{{ url_for('opportunities.list_opportunities') }}" class="card-link">
                    <div class="dashboard-item">
                        <h3>{{ stage }}</h3>
                        <p>件数: {{ count }}</p>
                        <p>金額: ¥{{ "{:,.0f}".format(amount or 0) }}</p>
                    </div>
                </a>
                {% else %}
                <p>商談はありません</p>
                {% endfor %}
            </div>
        </div>

        <div class="dashboard-section">
            <h2>直近のタスク</h2>
            <div class="dashboard-list">
                {% if tasks and tasks.items %}
                    {% for task in tasks.items %}
                    <a href="{{ url_for('tasks.edit_task', id=task.id) }}" class="card-link">
                        <div class="dashboard-item">
                            <h3>{{ task.title }}</h3>
                            <p>期限: {{ task.due_date.strftime('%Y-%m-%d %H:%M') if task.due_date }}</p>
                            <p>ステータス: {{ task.status }}</p>
                        </div>
                    </a>
                    {% endfor %}
                    {% if tasks.pages > 1 %}
                    <div class="pagination">
                        {% if tasks.has_prev %}
                            <a href="{{ url_for('main.dashboard', tasks_page=tasks.prev_num, leads_page=request.args.get('leads_page', 1), schedules_page=request.args.get('schedules_page', 1), emails_page=request.args.get('emails_page', 1)) }}" class="page-link">&laquo; 前へ</a>
                        {% endif %}
                        <span class="page-info">{{ tasks.page }} / {{ tasks.pages }}</span>
                        {% if tasks.has_next %}
                            <a href="{{ url_for('main.dashboard', tasks_page=tasks.next_num, leads_page=request.args.get('leads_page', 1), schedules_page=request.args.get('schedules_page', 1), emails_page=request.args.get('emails_page', 1)) }}" class="page-link">次へ &raquo;</a>
                        {% endif %}
                    </div>
                    {% endif %}
                {% else %}
                    <p>タスクはありません</p>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-section">
            <h2>今後のスケジュール</h2>
            <div class="dashboard-list">
                {% if schedules and schedules.items %}
                    {% for schedule in schedules.items %}
                    <a href="{{ url_for('schedules.edit_schedule', id=schedule.id) }}" class="card-link">
                        <div class="dashboard-item">
                            <h3>{{ schedule.title }}</h3>
                            <p>開始: {{ schedule.start_time.strftime('%Y-%m-%d %H:%M') if schedule.start_time }}</p>
                            <p>終了: {{ schedule.end_time.strftime('%Y-%m-%d %H:%M') if schedule.end_time }}</p>
                        </div>
                    </a>
                    {% endfor %}
                    {% if schedules.pages > 1 %}
                    <div class="pagination">
                        {% if schedules.has_prev %}
                            <a href="{{ url_for('main.dashboard', schedules_page=schedules.prev_num, leads_page=request.args.get('leads_page', 1), tasks_page=request.args.get('tasks_page', 1), emails_page=request.args.get('emails_page', 1)) }}" class="page-link">&laquo; 前へ</a>
                        {% endif %}
                        <span class="page-info">{{ schedules.page }} / {{ schedules.pages }}</span>
                        {% if schedules.has_next %}
                            <a href="{{ url_for('main.dashboard', schedules_page=schedules.next_num, leads_page=request.args.get('leads_page', 1), tasks_page=request.args.get('tasks_page', 1), emails_page=request.args.get('emails_page', 1)) }}" class="page-link">次へ &raquo;</a>
                        {% endif %}
                    </div>
                    {% endif %}
                {% else %}
                    <p>スケジュールはありません</p>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-section email-section">
            <h2>最近のメール</h2>
            <div class="dashboard-list email-grid">
                {% if emails and emails.items %}
                    {% for email in emails.items %}
                    <div class="dashboard-item email-card" onclick="showEmailModal('{{ email.id }}')">
                        <h3>{{ email.subject or '件名なし' }}</h3>
                        <p>送信者: {{ email.sender_name or email.sender }}</p>
                        <p>受信日時: {{ email.received_date.strftime('%Y-%m-%d %H:%M') if email.received_date }}</p>
                    </div>
                    {% endfor %}
                    {% if emails.pages > 1 %}
                    <div class="pagination">
                        {% if emails.has_prev %}
                            <a href="{{ url_for('main.dashboard', emails_page=emails.prev_num, leads_page=request.args.get('leads_page', 1), tasks_page=request.args.get('tasks_page', 1), schedules_page=request.args.get('schedules_page', 1)) }}" class="page-link">&laquo; 前へ</a>
                        {% endif %}
                        <span class="page-info">{{ emails.page }} / {{ emails.pages }}</span>
                        {% if emails.has_next %}
                            <a href="{{ url_for('main.dashboard', emails_page=emails.next_num, leads_page=request.args.get('leads_page', 1), tasks_page=request.args.get('tasks_page', 1), schedules_page=request.args.get('schedules_page', 1)) }}" class="page-link">次へ &raquo;</a>
                        {% endif %}
                    </div>
                    {% endif %}
                {% else %}
                    <p>メールはありません</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="emailModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 id="modalSubject"></h2>
        <div class="email-info">
            <p id="modalSender"></p>
            <p id="modalDate"></p>
        </div>
        <div class="email-content" id="modalContent"></div>
        
        <div id="aiAnalysisSection">
            <div id="analysisContent" style="display: none;">
                <h4>AI分析結果</h4>
                <div id="analysisResult"></div>
                
                <div id="generatedItems" class="mt-3">
                    <div id="tasksList" style="display: none;">
                        <h5>作成されたタスク</h5>
                        <ul class="list-group" id="tasksContainer"></ul>
                    </div>
                    
                    <div id="schedulesList" style="display: none;">
                        <h5>作成された予定</h5>
                        <ul class="list-group" id="schedulesContainer"></ul>
                    </div>
                </div>
            </div>
            
            <div id="analysisButton" class="mt-3">
                <button onclick="analyzeEmail()" class="btn btn-primary">
                    <i class="fas fa-robot"></i> AI分析を実行
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Original styles... */
</style>

<script>
async function showEmailModal(emailId) {
    try {
        const response = await fetch(`/api/emails/${emailId}`);
        const data = await response.json();

        if (data.error) {
            console.error('Error fetching email:', data.error);
            return;
        }

        document.getElementById('modalSubject').textContent = data.subject || '(件名なし)';
        document.getElementById('modalSender').textContent = `送信者: ${data.sender_name || data.sender}`;
        document.getElementById('modalDate').textContent = `受信日時: ${new Date(data.received_date).toLocaleString('ja-JP')}`;
        document.getElementById('modalContent').innerHTML = data.content || '(本文なし)';

        const analysisContent = document.getElementById('analysisContent');
        const analysisButton = document.getElementById('analysisButton');
        
        if (data.ai_analysis) {
            document.getElementById('analysisResult').innerHTML = data.ai_analysis;
            analysisContent.style.display = 'block';
            analysisButton.style.display = 'none';
            updateGeneratedItems(data.tasks, data.schedules);
        } else {
            analysisContent.style.display = 'none';
            analysisButton.style.display = 'block';
        }

        currentEmailId = emailId;
        document.getElementById('emailModal').style.display = 'block';
    } catch (error) {
        console.error('Error:', error);
    }
}

async function analyzeEmail() {
    if (!currentEmailId) return;

    const button = document.querySelector('#analysisButton button');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析中...';

    try {
        const response = await fetch(`/api/emails/${currentEmailId}/analyze`, {
            method: 'POST',
        });
        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        document.getElementById('analysisResult').innerHTML = data.analysis;
        document.getElementById('analysisContent').style.display = 'block';
        document.getElementById('analysisButton').style.display = 'none';
        updateGeneratedItems(data.tasks, data.schedules);

    } catch (error) {
        console.error('Error:', error);
        alert('分析中にエラーが発生しました');
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-robot"></i> AI分析を実行';
    }
}

function updateGeneratedItems(tasks, schedules) {
    const tasksDiv = document.getElementById('tasksList');
    const schedulesDiv = document.getElementById('schedulesList');
    const tasksContainer = document.getElementById('tasksContainer');
    const schedulesContainer = document.getElementById('schedulesContainer');

    if (tasks && tasks.length > 0) {
        tasksContainer.innerHTML = tasks.map(task => `
            <li class="list-group-item">
                <i class="fas fa-tasks"></i>
                ${task.title}
                <small class="text-muted">（期限: ${new Date(task.due_date).toLocaleDateString()}）</small>
            </li>
        `).join('');
        tasksDiv.style.display = 'block';
    } else {
        tasksDiv.style.display = 'none';
    }

    if (schedules && schedules.length > 0) {
        schedulesContainer.innerHTML = schedules.map(schedule => `
            <li class="list-group-item">
                <i class="fas fa-calendar"></i>
                ${schedule.title}
                <small class="text-muted">
                    （${new Date(schedule.start_time).toLocaleString()} - 
                     ${new Date(schedule.end_time).toLocaleTimeString()}）
                </small>
            </li>
        `).join('');
        schedulesDiv.style.display = 'block';
    } else {
        schedulesDiv.style.display = 'none';
    }
}

let currentEmailId = null;

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('emailModal');
    const closeBtn = document.querySelector('.close-modal');
    
    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
});
</script>
{% endblock %}