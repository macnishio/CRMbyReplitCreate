{% extends "base.html" %}
{% block title %}タスク一覧{% endblock %}

{% block content %}
<div class="tasks-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>タスク一覧</h1>
        <div>
            <a href="{{ url_for('tasks.add_task') }}" class="btn btn-primary">新規タスク追加</a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if tasks %}
    <form method="POST" action="{{ url_for('tasks.bulk_action') }}" id="bulkForm">
        <div class="mb-3">
            <select name="action" class="form-select d-inline-block w-auto">
                <option value="">一括操作を選択</option>
                <option value="complete">完了にする</option>
                <option value="incomplete">未完了にする</option>
                <option value="delete">削除</option>
            </select>
            <button type="submit" class="btn btn-secondary">適用</button>
        </div>

        <div class="task-grid">
            {% for task in tasks %}
            <div class="task-card">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="selected_tasks" value="{{ task.id }}">
                </div>
                <div class="task-content">
                    <h3>{{ task.title }}</h3>
                    <p class="task-description">{{ task.description }}</p>
                    <p class="task-due-date">期限: {{ task.due_date.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p class="task-status">
                        ステータス: 
                        {% if task.completed %}
                        <span class="badge bg-success">完了</span>
                        {% else %}
                        <span class="badge bg-warning">未完了</span>
                        {% endif %}
                    </p>
                    {% if task.lead %}
                    <p class="task-lead">リード: {{ task.lead.name }}</p>
                    {% endif %}
                    {% if task.opportunity %}
                    <p class="task-opportunity">商談: {{ task.opportunity.name }}</p>
                    {% endif %}
                    {% if task.account %}
                    <p class="task-account">取引先: {{ task.account.name }}</p>
                    {% endif %}
                </div>
                <div class="task-actions">
                    <a href="{{ url_for('tasks.edit_task', id=task.id) }}" class="btn btn-sm btn-primary">編集</a>
                    <form action="{{ url_for('tasks.delete_task', id=task.id) }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('本当に削除しますか？')">削除</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </form>
    {% else %}
    <p>タスクがありません。</p>
    {% endif %}
</div>

<style>
.tasks-container {
    padding: 20px;
}

.task-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.task-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    position: relative;
}

.task-card .form-check {
    position: absolute;
    top: 10px;
    right: 10px;
}

.task-content {
    margin-top: 20px;
}

.task-content h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
    color: #333;
}

.task-description {
    color: #666;
    margin-bottom: 10px;
}

.task-due-date,
.task-status,
.task-lead,
.task-opportunity,
.task-account {
    font-size: 14px;
    color: #666;
    margin: 5px 0;
}

.task-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

.badge {
    padding: 5px 10px;
}

.form-select {
    margin-right: 10px;
}
</style>
{% endblock %}
