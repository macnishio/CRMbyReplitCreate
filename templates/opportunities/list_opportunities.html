{% extends "base.html" %}
{% block title %}商談一覧{% endblock %}
{% block content %}
<!-- Filter Form -->
<div class="filter-section">
    <form method="GET" class="filter-form" id="filterForm">
        <div class="filter-header">
            <h2><i class="fas fa-filter"></i> フィルター設定</h2>
            <div class="filter-summary" id="filterSummary"></div>
        </div>
        <div class="filter-grid">
            <div class="filter-group">
                <label for="stage">
                    <i class="fas fa-chart-line"></i>
                    <span>ステージ</span>
                </label>
                <select name="stage" id="stage" class="form-select">
                    <option value="">全て</option>
                    <option value="Initial Contact" {% if filters.stage == 'Initial Contact' %}selected{% endif %}>
                        <i class="fas fa-handshake"></i> 初期接触
                    </option>
                    <option value="Qualification" {% if filters.stage == 'Qualification' %}selected{% endif %}>
                        <i class="fas fa-check-circle"></i> 資格確認
                    </option>
                    <option value="Proposal" {% if filters.stage == 'Proposal' %}selected{% endif %}>
                        <i class="fas fa-file-alt"></i> 提案
                    </option>
                    <option value="Negotiation" {% if filters.stage == 'Negotiation' %}selected{% endif %}>
                        <i class="fas fa-comments"></i> 交渉
                    </option>
                    <option value="Closed Won" {% if filters.stage == 'Closed Won' %}selected{% endif %}>
                        <i class="fas fa-check-double"></i> 成約
                    </option>
                    <option value="Closed Lost" {% if filters.stage == 'Closed Lost' %}selected{% endif %}>
                        <i class="fas fa-times-circle"></i> 失注
                    </option>
                </select>
            </div>
            <div class="filter-group">
                <label>
                    <i class="fas fa-yen-sign"></i>
                    <span>金額範囲</span>
                </label>
                <div class="amount-range">
                    <div class="input-group">
                        <span class="input-group-text">¥</span>
                        <input type="number" 
                               name="min_amount" 
                               class="form-control" 
                               placeholder="最小" 
                               value="{{ filters.min_amount or '' }}"
                               aria-label="最小金額">
                    </div>
                    <span class="range-separator">～</span>
                    <div class="input-group">
                        <span class="input-group-text">¥</span>
                        <input type="number" 
                               name="max_amount" 
                               class="form-control" 
                               placeholder="最大" 
                               value="{{ filters.max_amount or '' }}"
                               aria-label="最大金額">
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label for="lead_status">リードステータス:</label>
                <select name="lead_status" id="lead_status">
                    <option value="">全て</option>
                    <option value="New" {% if filters.lead_status == 'New' %}selected{% endif %}>新規</option>
                    <option value="Contacted" {% if filters.lead_status == 'Contacted' %}selected{% endif %}>連絡済み</option>
                    <option value="Qualified" {% if filters.lead_status == 'Qualified' %}selected{% endif %}>適格</option>
                    <option value="Unqualified" {% if filters.lead_status == 'Unqualified' %}selected{% endif %}>不適格</option>
                    <option value="Converted" {% if filters.lead_status == 'Converted' %}selected{% endif %}>成約</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="lead_search">リード検索:</label>
                <input type="text" name="lead_search" id="lead_search" value="{{ filters.lead_search or '' }}" placeholder="リード名を入力">
            </div>
            <div class="filter-group">
                <label>期間:</label>
                <div class="date-range">
                    <input type="date" name="date_from" value="{{ filters.date_from or '' }}">
                    <span>～</span>
                    <input type="date" name="date_to" value="{{ filters.date_to or '' }}">
                </div>
            </div>
            <div class="filter-group">
                <label>並び替え:</label>
                <div class="sort-controls">
                    <select name="sort_by" id="sort_by">
                        <option value="close_date" {% if filters.sort_by == 'close_date' %}selected{% endif %}>完了予定日</option>
                        <option value="amount" {% if filters.sort_by == 'amount' %}selected{% endif %}>金額</option>
                        <option value="name" {% if filters.sort_by == 'name' %}selected{% endif %}>商談名</option>
                        <option value="stage" {% if filters.sort_by == 'stage' %}selected{% endif %}>ステージ</option>
                    </select>
                    <select name="sort_order" id="sort_order">
                        <option value="asc" {% if filters.sort_order == 'asc' %}selected{% endif %}>昇順</option>
                        <option value="desc" {% if filters.sort_order == 'desc' %}selected{% endif %}>降順</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">フィルター適用</button>
            <button type="button" class="btn btn-secondary" onclick="resetFilters()">リセット</button>
            <button type="submit" class="btn btn-success" name="save_filters" value="1">
                <i class="fas fa-save"></i> フィルター設定を保存
            </button>
            <button type="button" class="btn btn-info" onclick="exportOpportunities()">
                <i class="fas fa-file-export"></i> エクスポート
            </button>
        </div>
        
        <script>
        function exportOpportunities() {
            const exportButton = document.querySelector('button[onclick="exportOpportunities()"]');
            const originalText = exportButton.innerHTML;
            
            // Disable button and show loading state
            exportButton.disabled = true;
            exportButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> エクスポート中...';
            
            // Get current filter parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Use fetch instead of direct navigation
            fetch('/opportunities/export?' + urlParams.toString())
                .then(response => {
                    if (!response.ok) {
                        throw new Error('エクスポートに失敗しました');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `商談リスト_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Export error:', error);
                    alert('エクスポート中にエラーが発生しました: ' + error.message);
                })
                .finally(() => {
                    // Reset button state
                    exportButton.disabled = false;
                    exportButton.innerHTML = originalText;
                });
        }
        </script>
    </form>
</div>
<h1>商談一覧</h1>

<!-- Bulk Operations Form -->
<form method="POST" action="{{ url_for('opportunities.bulk_action') }}" id="bulkForm">
    <div class="bulk-actions">
        <div class="select-all-container">
            <input type="checkbox" id="select-all" onclick="toggleAllCheckboxes()">
            <label for="select-all">すべて選択</label>
        </div>
        <select name="action" id="bulk-action">
            <option value="">一括操作を選択...</option>
            <option value="delete">削除</option>
            <option value="change_stage">ステージ変更</option>
        </select>
        <select name="new_stage" id="new-stage" style="display: none;">
            <option value="Initial Contact">初期接触</option>
            <option value="Qualification">資格確認</option>
            <option value="Proposal">提案</option>
            <option value="Negotiation">交渉</option>
            <option value="Closed Won">成約</option>
            <option value="Closed Lost">失注</option>
        </select>
        <button type="submit" class="btn btn-primary" onclick="return confirmBulkAction()">適用</button>
    </div>

    <!-- AI Analysis Section -->
    <div class="ai-analysis-section">
        <div class="analysis-header">
            <h2 onclick="toggleAnalysis()">商談分析 <span class="toggle-icon">▼</span></h2>
            <button type="button" class="btn btn-primary btn-run-analysis" onclick="runAnalysis()">
                <i class="fas fa-sync"></i> 分析を実行
            </button>
        </div>
        <div class="analysis-content" id="analysisContent">
            <div id="analysisError" class="analysis-error" style="display: none;"></div>
            <div id="analysisLoading" class="analysis-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> 分析中...
            </div>
            <div class="analysis-grid">
                <!-- Stage Distribution -->
<style>
.filter-section {
    margin: 20px 0;
    padding: 24px;
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.filter-section:hover {
    box-shadow: 0 6px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.12);
}

.filter-header {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e9ecef;
}

.filter-header h2 {
    font-size: 1.5rem;
    color: #2d3748;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-header h2 i {
    color: #4a5568;
}

.filter-summary {
    margin-top: 12px;
    font-size: 0.875rem;
    color: #718096;
}

.filter-form {
    width: 100%;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.filter-group label {
    font-weight: 500;
    color: #4a5568;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
}

.filter-group label i {
    color: #718096;
    width: 16px;
    text-align: center;
}

.filter-group select,
.filter-group input,
.filter-group .form-select,
.filter-group .form-control {
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background-color: #fff;
}

.filter-group select:hover,
.filter-group input:hover,
.filter-group .form-select:hover,
.filter-group .form-control:hover {
    border-color: #cbd5e0;
}

.filter-group select:focus,
.filter-group input:focus,
.filter-group .form-select:focus,
.filter-group .form-control:focus {
    border-color: #3182ce;
    box-shadow: 0 0 0 3px rgba(49,130,206,0.1);
    outline: none;
}

.amount-range,
.date-range {
    display: flex;
    align-items: center;
    gap: 12px;
}

.amount-range .input-group,
.date-range .input-group {
    flex: 1;
    display: flex;
    align-items: center;
}

.input-group-text {
    padding: 10px 12px;
    background-color: #f7fafc;
    border: 1px solid #e2e8f0;
    border-right: none;
    border-radius: 8px 0 0 8px;
    color: #4a5568;
    font-weight: 500;
}

.input-group .form-control {
    border-left: none;
    border-radius: 0 8px 8px 0;
}

.range-separator {
    color: #718096;
    font-weight: 500;
    padding: 0 4px;
}

.sort-controls {
    display: flex;
    gap: 12px;
    align-items: center;
}

.sort-controls select {
    min-width: 140px;
}

.filter-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: flex-end;
    padding-top: 24px;
    margin-top: 24px;
    border-top: 1px solid #e9ecef;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.btn i {
    font-size: 0.9em;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.btn-primary {
    background-color: #3182ce;
    color: white;
}

.btn-primary:hover {
    background-color: #2c5282;
}

.btn-secondary {
    background-color: #f7fafc;
    color: #4a5568;
    border: 1px solid #e2e8f0;
}

.btn-secondary:hover {
    background-color: #edf2f7;
}

.btn-success {
    background-color: #48bb78;
    color: white;
}

.btn-success:hover {
    background-color: #38a169;
}

.btn-info {
    background-color: #4299e1;
    color: white;
}

.btn-info:hover {
    background-color: #3182ce;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}
<style>
/* Analysis section styles */
.ai-analysis-section {
    margin: 20px 0;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.analysis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
}

.analysis-header h2 {
    cursor: pointer;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.analysis-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.analysis-card {
    background: white;
    padding: 15px;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.analysis-card h3 {
    margin-bottom: 15px;
    color: #333;
}

.analysis-loading {
    text-align: center;
    padding: 20px;
    font-size: 1.2em;
    color: #666;
}

.analysis-error {
    background-color: #fff3f3;
    color: #dc3545;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 15px;
    border: 1px solid #ffcdd2;
}

.btn-run-analysis {
    transition: all 0.3s ease;
}

.btn-run-analysis:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
}

.btn-run-analysis:hover:not(:disabled) {
    opacity: 0.9;
}

.toggle-icon {
    transition: transform 0.3s ease;
}
</style>
</style>

<script>
function toggleAnalysis() {
    const content = document.getElementById('analysisContent');
    const icon = document.querySelector('.toggle-icon');
    if (content.style.maxHeight) {
        content.style.maxHeight = null;
        icon.textContent = '▶';
    } else {
        content.style.maxHeight = content.scrollHeight + "px";
        icon.textContent = '▼';
    }
}

function showError(message, isTemporary = true) {
    const errorDiv = document.getElementById('analysisError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    if (isTemporary) {
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const analyzeButton = document.querySelector('.btn-run-analysis');
    if (analyzeButton) {
        analyzeButton.addEventListener('click', runAnalysis);
    }
});

function runAnalysis() {
    // デバッグ用のログ追加
    console.log('Analysis started');
    
    // 必要な要素の取得と存在確認
    const elements = {
        loadingDiv: document.getElementById('analysisLoading'),
        analysisGrid: document.querySelector('.analysis-grid'),
        errorDiv: document.getElementById('analysisError'),
        runButton: document.querySelector('.btn-run-analysis'),
        stageStats: document.querySelector('.analysis-card:first-child'),
        aiAnalysis: document.querySelector('.analysis-card:last-child')
    };

    // 要素の存在確認とデバッグログ
    for (const [key, element] of Object.entries(elements)) {
        if (!element) {
            console.error(`Missing element: ${key}`);
        }
    }

    // 初期状態のリセット
    if (elements.errorDiv) {
        elements.errorDiv.style.display = 'none';
    }
    
    // ローディング状態の表示
    const setLoadingState = (isLoading) => {
        if (elements.loadingDiv) {
            elements.loadingDiv.style.display = isLoading ? 'block' : 'none';
        }
        if (elements.analysisGrid) {
            elements.analysisGrid.style.opacity = isLoading ? '0.5' : '1';
        }
        if (elements.runButton) {
            elements.runButton.disabled = isLoading;
            elements.runButton.innerHTML = isLoading ? 
                '<i class="fas fa-spinner fa-spin"></i> 分析中...' : 
                '<i class="fas fa-sync"></i> 分析を実行';
        }
    };

    // エラー表示
    const showError = (message) => {
        if (elements.errorDiv) {
            elements.errorDiv.style.display = 'block';
            elements.errorDiv.textContent = message;
        }
        console.error('Analysis error:', message);
    };

    // 分析の実行
    setLoadingState(true);

    fetch('/opportunities/analyze', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('サーバーエラーが発生しました');
        }
        return response.json();
    })
    .then(data => {
        console.log('Analysis data received:', data);
        if (data.success) {
            // 統計情報の更新
            if (elements.stageStats) {
                let statsHtml = '<h3>ステージ分布</h3>';
                if (!data.stage_stats || data.stage_stats.length === 0) {
                    statsHtml += '<p>分析対象のデータがありません。</p>';
                } else {
                    data.stage_stats.forEach(stat => {
                        const amount = new Intl.NumberFormat('ja-JP').format(stat.amount || 0);
                        statsHtml += `<p>${stat.stage}: ${stat.count}件 (¥${amount})</p>`;
                    });
                }
                elements.stageStats.innerHTML = statsHtml;
            }

            // AI分析結果の更新
            if (elements.aiAnalysis) {
                elements.aiAnalysis.innerHTML = `
                    <h3>AI分析結果</h3>
                    ${data.ai_analysis || '<p>AI分析を実行できませんでした。</p>'}
                `;
            }
        } else {
            throw new Error(data.error || '分析中に不明なエラーが発生しました');
        }
    })
    .catch(error => {
        console.error('Analysis error:', error);
        showError('分析の実行中にエラーが発生しました。しばらく待ってから再度お試しください。');
    })
    .finally(() => {
        setLoadingState(false);
    });
}
</script>

<script>
function resetFilters() {
    // Reset all form fields
    document.getElementById('filterForm').reset();
    // Submit the form to clear all filters
    document.getElementById('filterForm').submit();
}

// Add event listeners for automatic form submission when sort options change
document.getElementById('sort_by').addEventListener('change', function() {
    document.getElementById('filterForm').submit();
});

document.getElementById('sort_order').addEventListener('change', function() {
    document.getElementById('filterForm').submit();
});
</script>
                <div class="analysis-card">
                    <h3>ステージ分布</h3>
                    {% for stat in opp_stage_stats %}
                    <p>{{ stat.stage }}: {{ stat.count }}件 ({{ "¥{:,.0f}".format(stat.amount or 0) }})</p>
                    {% endfor %}
                </div>

                <!-- AI Insights -->
                <div class="analysis-card">
                    <h3>AI分析結果</h3>
                    {% if ai_analysis %}
                        {{ ai_analysis|safe }}
                    {% else %}
                        <p>AI分析を実行できませんでした。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Opportunities Grid -->
    <div class="opportunity-grid">
        {% for opportunity in opportunities.items %}
        <div class="opportunity-card">
            <div class="opportunity-select">
                <input type="checkbox" name="selected_opportunities[]" value="{{ opportunity.id }}" class="opportunity-checkbox">
            </div>
            <h2>{{ opportunity.name }}</h2>
            <p><strong>ステージ:</strong> {{ opportunity.stage }}</p>
            <p><strong>金額:</strong> {{ "¥{:,.0f}".format(opportunity.amount or 0) }}</p>
            <p><strong>完了予定日:</strong> {{ opportunity.close_date.strftime('%Y-%m-%d') if opportunity.close_date }}</p>
            {% if opportunity.lead %}
            <div class="lead-info">
                <p><strong>リード情報:</strong></p>
                <ul>
                    <li><strong>名前:</strong> {{ opportunity.lead.name }}</li>
                    <li><strong>メール:</strong> {{ opportunity.lead.email }}</li>
                    <li><strong>スコア:</strong> {{ "%.1f"|format(opportunity.lead.score) }}</li>
                    <li><strong>ステータス:</strong> {{ opportunity.lead.status }}</li>
                </ul>
            </div>
            {% else %}
            <p class="no-lead">リードが関連付けられていません</p>
            {% endif %}
            <div class="card-actions">
                <a href="{{ url_for('opportunities.edit_opportunity', id=opportunity.id) }}" class="btn btn-edit">編集</a>
                <button type="button" class="btn btn-delete" onclick="deleteOpportunity({{ opportunity.id }})">削除</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if opportunities.pages > 1 %}
    <div class="pagination-container">
        <div class="pagination">
            {% if opportunities.has_prev %}
                <a href="{{ url_for('opportunities.list_opportunities', page=opportunities.prev_num, stage=filters.stage, min_amount=filters.min_amount, max_amount=filters.max_amount, lead_search=filters.lead_search, lead_status=filters.lead_status, date_from=filters.date_from, date_to=filters.date_to, sort_by=filters.sort_by, sort_order=filters.sort_order) }}" class="page-link">&laquo; 前へ</a>
            {% endif %}

            {% for page_num in range(opportunities.page - 2, opportunities.page + 3) if page_num > 0 and page_num <= opportunities.pages %}
                <a href="{{ url_for('opportunities.list_opportunities', page=page_num, stage=filters.stage, min_amount=filters.min_amount, max_amount=filters.max_amount, lead_search=filters.lead_search, lead_status=filters.lead_status, date_from=filters.date_from, date_to=filters.date_to, sort_by=filters.sort_by, sort_order=filters.sort_order) }}" 
                   class="page-link {% if page_num == opportunities.page %}active{% endif %}">
                    {{ page_num }}
                </a>
            {% endfor %}

            {% if opportunities.has_next %}
                <a href="{{ url_for('opportunities.list_opportunities', page=opportunities.next_num, stage=filters.stage, min_amount=filters.min_amount, max_amount=filters.max_amount, lead_search=filters.lead_search, lead_status=filters.lead_status, date_from=filters.date_from, date_to=filters.date_to, sort_by=filters.sort_by, sort_order=filters.sort_order) }}" class="page-link">次へ &raquo;</a>
            {% endif %}
        </div>
        <div class="pagination-info">
            ページ {{ opportunities.page }} / {{ opportunities.pages }} (全{{ opportunities.total }}件)
        </div>
    </div>
    {% endif %}
</form>

<div class="add-opportunity">
    <a href="{{ url_for('opportunities.add_opportunity') }}" class="btn btn-add">新規商談を追加</a>
</div>

<style>
.bulk-actions {
    margin: 20px 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.select-all-container {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-right: 15px;
}

.opportunity-select {
    position: absolute;
    top: 10px;
    right: 10px;
}

.opportunity-card {
    position: relative;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.lead-info {
    margin-top: 15px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
}

.lead-info ul {
    list-style: none;
    padding-left: 0;
    margin: 5px 0;
}

.lead-info li {
    margin: 5px 0;
}

.no-lead {
    color: #6c757d;
    font-style: italic;
    margin-top: 10px;
}

.card-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn-edit, .btn-delete {
    padding: 8px 16px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-edit {
    background-color: #007bff;
    color: white;
    text-decoration: none;
}

.btn-delete {
    background-color: #dc3545;
    color: white;
}

.btn-edit:hover {
    background-color: #0056b3;
}

.btn-delete:hover {
    background-color: #c82333;
}

.btn-add {
    background-color: #28a745;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    display: inline-block;
    margin-top: 20px;
    transition: background-color 0.3s ease;
}

.btn-add:hover {
    background-color: #218838;
}

.analysis-section {
    margin: 20px 0;
    border: 1px solid #dee2e6;
    border-radius: 5px;
}

.analysis-header {
    padding: 10px;
    background-color: #f8f9fa;
    cursor: pointer;
}

.analysis-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    padding: 20px;
}

.analysis-card {
    background: white;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.toggle-icon {
    transition: transform 0.3s ease;
}

.opportunity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}
</style>

<script>
function toggleAnalysis() {
    const content = document.getElementById('analysisContent');
    const icon = document.querySelector('.toggle-icon');
    
    if (content.style.maxHeight) {
        content.style.maxHeight = null;
        icon.style.transform = 'rotate(0deg)';
    } else {
        content.style.maxHeight = content.scrollHeight + "px";
        icon.style.transform = 'rotate(180deg)';
    }
}

function toggleAllCheckboxes() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.opportunity-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

document.getElementById('bulk-action').addEventListener('change', function() {
    const newStageSelect = document.getElementById('new-stage');
    newStageSelect.style.display = this.value === 'change_stage' ? 'inline-block' : 'none';
});

function confirmBulkAction() {
    const action = document.getElementById('bulk-action').value;
    const selectedOpportunities = document.querySelectorAll('input[name="selected_opportunities[]"]:checked').length;
    
    if (!action) {
        alert('操作を選択してください。');
        return false;
    }
    
    if (selectedOpportunities === 0) {
        alert('商談を選択してください。');
        return false;
    }
    
    if (action === 'delete') {
        return confirm(`選択された${selectedOpportunities}件の商談を削除してもよろしいですか？`);
    }
    
    return true;
}

function deleteOpportunity(id) {
    if (confirm('この商談を削除してもよろしいですか？')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{{ url_for('opportunities.delete_opportunity', id=0) }}`.replace('0', id);
        document.body.appendChild(form);
        form.submit();
    }
}

// Update select-all checkbox state when individual checkboxes change
document.querySelectorAll('.opportunity-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.opportunity-checkbox');
        const selectAll = document.getElementById('select-all');
        selectAll.checked = [...checkboxes].every(cb => cb.checked);
    });
});
</script>
{% endblock %}